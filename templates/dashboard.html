<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª GPU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="/static/styles.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a !important; display: block !important; color: #f1f5f9; }
        #bgCanvas { display: none !important; }
        .card { background-color: #1e293b !important; border: 1px solid #334155; margin-bottom: 2rem; border-radius: 12px; }
        .card-header { background-color: rgba(15, 23, 42, 0.6) !important; border-bottom: 1px solid #334155; color: #38bdf8 !important; font-weight: 800; padding: 1rem 1.5rem; }
        .form-control, .form-select { background-color: #0f172a !important; border: 1px solid #475569; color: #fff !important; }
        .form-control:focus, .form-select:focus { border-color: #38bdf8; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }
        .table { color: #e2e8f0 !important; margin-bottom: 0; }
        .table thead th { background-color: #0f172a !important; color: #94a3b8 !important; border-bottom: 2px solid #334155; text-align: center; vertical-align: middle;}
        .table tbody td { vertical-align: middle; border-bottom: 1px solid #334155; text-align: center; background-color: #1e293b; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: #1e293b !important; border-bottom: 1px solid #334155;">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#" style="color: #38bdf8 !important; font-weight: 900;">
                <i class="bi bi-cloud-drizzle-fill ms-2 fs-4"></i>
                <span>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø¨Ø±ÛŒ</span>
            </a>
            
            <div class="d-flex align-items-center">
                <span class="text-light ms-3 d-flex align-items-center gap-3" id="username-display"></span>
                
                <button onclick="logout()" class="btn btn-outline-danger btn-sm px-3 d-flex align-items-center">
                    <i class="bi bi-box-arrow-left ms-2"></i>Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-rocket-takeoff-fill ms-2 fs-5"></i>
                <span>Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</span>
            </div>
            <div class="card-body">
                <form id="jobForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Ù†ÙˆØ¹ Ú©Ø§Ø±Øª Ú¯Ø±Ø§ÙÛŒÚ©</label>
                            <select class="form-select" id="gpuType">
                                <option value="T4">NVIDIA T4</option>
                                <option value="V100">NVIDIA V100</option>
                                <option value="A100">NVIDIA A100</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ØªØ¹Ø¯Ø§Ø¯</label>
                            <input type="number" class="form-control" id="gpuCount" value="1" min="1" oninput="validity.valid||(value='1');">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ù…Ø¯Øª (Ø«Ø§Ù†ÛŒÙ‡)</label>
                            <input type="number" class="form-control" id="estimatedDuration" value="10" min="5" max="60">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Ø¯Ø³ØªÙˆØ±</label>
                            <input type="text" class="form-control" id="command" required placeholder="Ù…Ø«Ù„Ø§Ù‹: python train.py">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100 fw-bold d-flex justify-content-center align-items-center">
                                <i class="bi bi-send-fill ms-2"></i>Ø§Ø±Ø³Ø§Ù„
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center">
                    <i class="bi bi-clipboard-data-fill ms-2 fs-5"></i>
                    ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </span>
                <button onclick="loadJobs()" class="btn btn-sm btn-outline-info d-flex align-items-center">
                    <i class="bi bi-arrow-clockwise ms-1"></i>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table" id="jobsTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="10%">Ú©Ø§Ø±Ø¨Ø±</th>
                                <th width="15%">Ù…Ù†Ø§Ø¨Ø¹</th>
                                <th width="15%">Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ</th>
                                <th width="20%">Ø¯Ø³ØªÙˆØ±</th>
                                <th width="20%">ÙˆØ¶Ø¹ÛŒØª</th>
                                <th width="15%">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = ""; 
        let currentUser = null;
        let updateInterval = null;

        async function checkLogin() {
            const token = localStorage.getItem("access_token");
            if (!token) { window.location.href = "/"; return; }
            try {
                const res = await fetch(`${API_URL}/users/me`, { headers: { "Authorization": `Bearer ${token}` } });
                if (res.ok) {
                    currentUser = await res.json();
                    
                    let roleBadge = currentUser.is_admin ? 
                        '<span class="badge bg-warning text-dark d-inline-flex align-items-center"><i class="bi bi-shield-lock-fill ms-1"></i>Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…</span>' : 
                        '<span class="badge bg-secondary d-inline-flex align-items-center"><i class="bi bi-person-fill ms-1"></i>Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ</span>';
                    
                    // ğŸ‘‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² gap-3 Ø¯Ø± ÙˆØ§Ù„Ø¯ Ø¨Ø±Ø§ÛŒ ÙØ§ØµÙ„Ù‡ Ø§Ù†Ø¯Ø§Ø®ØªÙ† Ø¨ÛŒÙ† Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
                    document.getElementById("username-display").innerHTML = `
                        <i class="bi bi-person-circle fs-5"></i>
                        <span class="fw-bold">${currentUser.username}</span>
                        ${roleBadge}
                    `;
                    
                    loadJobs();
                    updateInterval = setInterval(loadJobs, 3000);
                } else logout();
            } catch (error) { alert("Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±"); }
        }

        function logout() { localStorage.removeItem("access_token"); clearInterval(updateInterval); window.location.href = "/"; }

        document.getElementById("jobForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const token = localStorage.getItem("access_token");
            const countVal = parseInt(document.getElementById("gpuCount").value);
            if (countVal < 1) { alert("ØªØ¹Ø¯Ø§Ø¯ Ú¯Ø±Ø§ÙÛŒÚ© Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û± Ø¨Ø§Ø´Ø¯"); return; }

            try {
                const res = await fetch(`${API_URL}/jobs/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({
                        gpu_type: document.getElementById("gpuType").value,
                        gpu_count: countVal,
                        command: document.getElementById("command").value,
                        estimated_duration: parseInt(document.getElementById("estimatedDuration").value)
                    })
                });
                if (res.ok) { document.getElementById("jobForm").reset(); loadJobs(); }
                else { const err = await res.json(); alert(`âŒ Ø®Ø·Ø§: ${err.detail}`); }
            } catch (e) { alert("Ø®Ø·Ø§"); }
        });

        function formatTime(isoString) {
            if (!isoString) return "-";
            return new Date(isoString).toLocaleTimeString('fa-IR');
        }

        async function loadJobs() {
            const token = localStorage.getItem("access_token");
            const tbody = document.querySelector("#jobsTable tbody");
            try {
                const res = await fetch(`${API_URL}/jobs/`, { headers: { "Authorization": `Bearer ${token}` } });
                if (res.ok) {
                    const jobs = await res.json();
                    tbody.innerHTML = "";
                    if (jobs.length === 0) { tbody.innerHTML = "<tr><td colspan='7' class='text-center p-4 text-muted'>Ø®Ø§Ù„ÛŒ</td></tr>"; return; }

                    jobs.forEach(job => {
                        let statusContent = "";
                        if (job.status === "PENDING") statusContent = `<span class="badge bg-warning text-dark d-inline-flex align-items-center"><i class="bi bi-hourglass-split ms-1"></i>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>`;
                        else if (job.status === "APPROVED") statusContent = `<span class="badge bg-primary d-inline-flex align-items-center"><i class="bi bi-check2-circle ms-1"></i>ØªØ§ÛŒÛŒØ¯ Ø´Ø¯</span>`;
                        else if (job.status === "RUNNING") statusContent = `<div class="text-info small d-inline-flex align-items-center"><i class="bi bi-cpu ms-1"></i>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</div><div class="progress" style="height:4px; margin-top:2px"><div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div></div>`;
                        else if (job.status === "COMPLETED") statusContent = `<span class="badge bg-success d-inline-flex align-items-center"><i class="bi bi-check-circle-fill ms-1"></i>Ù¾Ø§ÛŒØ§Ù†</span>`;
                        else if (job.status === "FAILED") statusContent = `<span class="badge bg-danger d-inline-flex align-items-center"><i class="bi bi-x-circle-fill ms-1"></i>Ø±Ø¯ Ø´Ø¯</span>`;

                        let timeDisplay = `<div style="font-size:0.75rem; color:#94a3b8">Ø«Ø¨Øª: ${formatTime(job.created_at)}</div>`;
                        if (job.completed_at) timeDisplay += `<div style="font-size:0.75rem; color:#4ade80">Ù¾Ø§ÛŒØ§Ù†: ${formatTime(job.completed_at)}</div>`;

                        let btns = `<button onclick="deleteJob(${job.id})" class="btn btn-sm btn-outline-danger" title="Ø­Ø°Ù"><i class="bi bi-trash3-fill"></i></button>`;
                        
                        if (currentUser && currentUser.is_admin && job.status === "PENDING") {
                            btns += ` <button onclick="updateStatus(${job.id}, 'APPROVED')" class="btn btn-sm btn-success"><i class="bi bi-check-lg"></i></button>
                                      <button onclick="updateStatus(${job.id}, 'FAILED')" class="btn btn-sm btn-danger"><i class="bi bi-x-lg"></i></button>`;
                        }

                        tbody.innerHTML += `<tr>
                            <td>${job.id}</td>
                            <td>${job.owner_id}</td>
                            <td>
                                <span class="badge bg-dark border border-secondary d-inline-flex align-items-center" style="font-family:monospace">
                                    <i class="bi bi-gpu-card ms-2"></i>${job.gpu_count} Ã— ${job.gpu_type}
                                </span>
                            </td>
                            <td>${timeDisplay}</td>
                            <td><code>${job.command}</code></td>
                            <td>${statusContent}</td>
                            <td>${btns}</td>
                        </tr>`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function updateStatus(id, st) {
            const t = localStorage.getItem("access_token");
            await fetch(`${API_URL}/jobs/${id}?status_update=${st}`, { method: "PUT", headers: {"Authorization": `Bearer ${t}`} });
            loadJobs();
        }

        async function deleteJob(id) {
            if(!confirm("Ø¢ÛŒØ§ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
            const t = localStorage.getItem("access_token");
            await fetch(`${API_URL}/jobs/${id}`, { method: "DELETE", headers: {"Authorization": `Bearer ${t}`} });
            loadJobs();
        }
        checkLogin();
    </script>
</body>
</html>