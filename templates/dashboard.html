<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª GPU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #0f172a !important;
            display: block !important;
            color: #f1f5f9;
        }
        #bgCanvas { display: none !important; }

        .card {
            background-color: #1e293b !important;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            margin-bottom: 2rem;
            border-radius: 12px;
        }
        .card-header {
            background-color: rgba(15, 23, 42, 0.6) !important;
            border-bottom: 1px solid #334155;
            color: #38bdf8 !important;
            font-weight: 800;
            padding: 1rem 1.5rem;
        }
        .form-control, .form-select {
            background-color: #0f172a !important;
            border: 1px solid #475569;
            color: #fff !important;
        }
        .form-control:focus, .form-select:focus {
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }
        .form-label { color: #cbd5e1; }

        /* Ø¬Ø¯ÙˆÙ„ */
        .table { color: #e2e8f0 !important; margin-bottom: 0; }
        .table thead th {
            background-color: #0f172a !important;
            color: #94a3b8 !important;
            border-bottom: 2px solid #334155;
            text-align: center;
        }
        .table tbody td {
            vertical-align: middle;
            border-bottom: 1px solid #334155;
            text-align: center;
            background-color: #1e293b;
        }
        
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª */
        .progress {
            height: 10px;
            background-color: #334155;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar-animated {
            animation: progress-move 2s linear infinite;
        }
        @keyframes progress-move {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: #1e293b !important; border-bottom: 1px solid #334155;">
        <div class="container">
            <a class="navbar-brand" href="#" style="color: #38bdf8 !important; font-weight: 900;">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø¨Ø±ÛŒ â˜ï¸</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3 fw-bold" id="username-display"></span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm px-3">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">ğŸš€ Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</div>
            <div class="card-body">
                <form id="jobForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Ù†ÙˆØ¹ Ú©Ø§Ø±Øª</label>
                            <select class="form-select" id="gpuType">
                                <option value="T4">NVIDIA T4</option>
                                <option value="V100">NVIDIA V100</option>
                                <option value="A100">NVIDIA A100</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡)</label>
                            <input type="number" class="form-control" id="estimatedDuration" value="10" min="5" max="60">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Ø¯Ø³ØªÙˆØ±</label>
                            <input type="text" class="form-control" id="command" required placeholder="Ù…Ø«Ù„Ø§Ù‹: python train.py">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100 fw-bold">Ø§Ø±Ø³Ø§Ù„</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ (Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±)</span>
                <span id="last-update" class="badge bg-dark text-muted" style="font-size: 0.7rem">...</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table" id="jobsTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="10%">Ú©Ø§Ø±Ø¨Ø±</th>
                                <th width="15%">Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø±</th>
                                <th width="25%">Ø¯Ø³ØªÙˆØ±</th>
                                <th width="20%">ÙˆØ¶Ø¹ÛŒØª / Ù¾ÛŒØ´Ø±ÙØª</th> <th width="15%">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_URL = ""; 
        let currentUser = null;
        let updateInterval = null; // Ø¨Ø±Ø§ÛŒ Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±

        async function checkLogin() {
            const token = localStorage.getItem("access_token");
            if (!token) { window.location.href = "/"; return; }
            try {
                const res = await fetch(`${API_URL}/users/me`, { headers: { "Authorization": `Bearer ${token}` } });
                if (res.ok) {
                    currentUser = await res.json();
                    document.getElementById("username-display").innerText = `ğŸ‘¤ ${currentUser.username}`;
                    loadJobs();
                    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± (Ù‡Ø± 2 Ø«Ø§Ù†ÛŒÙ‡)
                    updateInterval = setInterval(loadJobs, 2000);
                } else logout();
            } catch (error) { alert("Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±"); }
        }

        function logout() {
            localStorage.removeItem("access_token");
            clearInterval(updateInterval);
            window.location.href = "/";
        }

        document.getElementById("jobForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const token = localStorage.getItem("access_token");
            const duration = parseInt(document.getElementById("estimatedDuration").value);
            
            const jobData = {
                gpu_type: document.getElementById("gpuType").value,
                gpu_count: 1, // ÙØ¹Ù„Ø§ Ø«Ø§Ø¨Øª Û±
                command: document.getElementById("command").value,
                estimated_duration: duration
            };

            try {
                const res = await fetch(`${API_URL}/jobs/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify(jobData)
                });
                if (res.ok) {
                    document.getElementById("command").value = ""; // ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ± Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
                    loadJobs();
                } else {
                    const err = await res.json();
                    alert(`âŒ Ø®Ø·Ø§: ${err.detail}`);
                }
            } catch (error) { alert("Ø®Ø·Ø§"); }
        });

        async function loadJobs() {
            const token = localStorage.getItem("access_token");
            const tbody = document.querySelector("#jobsTable tbody");
            
            try {
                const response = await fetch(`${API_URL}/jobs/`, { headers: { "Authorization": `Bearer ${token}` } });
                if (response.ok) {
                    const jobs = await response.json();
                    tbody.innerHTML = "";
                    
                    // Ø¢Ù¾Ø¯ÛŒØª Ø³Ø§Ø¹Øª Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    const now = new Date();
                    document.getElementById("last-update").innerText = `Ø¢Ø®Ø±ÛŒÙ† Ú†Ú©: ${now.toLocaleTimeString()}`;

                    if (jobs.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='6' class='text-center p-3 text-muted'>Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</td></tr>";
                        return;
                    }

                    jobs.forEach(job => {
                        let statusContent = "";
                        
                        if (job.status === "PENDING") { 
                            statusContent = `<span class="badge bg-warning text-dark">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</span>`; 
                        } 
                        else if (job.status === "APPROVED") { 
                            statusContent = `<span class="badge bg-primary">âœ… ØªØ§ÛŒÛŒØ¯ Ø´Ø¯ (Ø¯Ø± ØµÙ Ø§Ø¬Ø±Ø§)</span>`; 
                        } 
                        else if (job.status === "RUNNING") {
                            // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª ÙˆÙ‚ØªÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª
                            statusContent = `
                                <div class="text-info small mb-1">âš™ï¸ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                         role="progressbar" style="width: 100%"></div>
                                </div>
                            `;
                        } 
                        else if (job.status === "COMPLETED") { 
                            statusContent = `<span class="badge bg-success">ğŸ‰ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØªÙ‡</span>`; 
                        }
                        else if (job.status === "FAILED") { 
                            statusContent = `<span class="badge bg-danger">âŒ Ø±Ø¯ Ø´Ø¯Ù‡</span>`; 
                        }

                        let actionButtons = "-";
                        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ùˆ ÙˆÙ‚ØªÛŒ ÙˆØ¶Ø¹ÛŒØª PENDING Ø§Ø³Øª
                        if (currentUser && currentUser.is_admin && job.status === "PENDING") {
                            actionButtons = `
                                <button onclick="updateStatus(${job.id}, 'APPROVED')" class="btn btn-sm btn-success">âœ”</button>
                                <button onclick="updateStatus(${job.id}, 'FAILED')" class="btn btn-sm btn-danger">âœ–</button>
                            `;
                        }

                        tbody.innerHTML += `
                            <tr>
                                <td>${job.id}</td>
                                <td>${job.owner_id}</td>
                                <td>${job.gpu_type} (${job.estimated_duration}s)</td>
                                <td><code>${job.command}</code></td>
                                <td>${statusContent}</td>
                                <td>${actionButtons}</td>
                            </tr>
                        `;
                    });
                }
            } catch (error) { console.error(error); }
        }

        async function updateStatus(jobId, newStatus) {
            const token = localStorage.getItem("access_token");
            // ØªØ§ÛŒÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ø³ÙˆØ§Ù„ Ù¾Ø±Ø³ÛŒØ¯Ù† Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ±
            await fetch(`${API_URL}/jobs/${jobId}?status_update=${newStatus}`, {
                method: "PUT",
                headers: { "Authorization": `Bearer ${token}` }
            });
            loadJobs();
        }

        checkLogin();
    </script>
</body>
</html>