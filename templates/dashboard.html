<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت GPU</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
    
    <style>
        /* --- تنظیمات تم تیره (Dark Mode Overrides) --- */
        body { background-color: #0f172a !important; display: block !important; color: #f1f5f9; }
        #bgCanvas { display: none !important; } /* غیرفعال کردن انیمیشن پس‌زمینه در داشبورد */
        
        /* استایل کارت‌ها و هدرها */
        .card { background-color: #1e293b !important; border: 1px solid #334155; margin-bottom: 2rem; border-radius: 12px; }
        .card-header { background-color: rgba(15, 23, 42, 0.6) !important; border-bottom: 1px solid #334155; color: #38bdf8 !important; font-weight: 800; padding: 1rem 1.5rem; }
        
        /* استایل ورودی‌ها (Inputs) */
        .form-control, .form-select { background-color: #0f172a !important; border: 1px solid #475569; color: #fff !important; }
        .form-control:focus, .form-select:focus { border-color: #38bdf8; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }
        
        /* استایل جدول (Table) */
        .table { color: #e2e8f0 !important; margin-bottom: 0; }
        .table thead th { background-color: #0f172a !important; color: #94a3b8 !important; border-bottom: 2px solid #334155; text-align: center; vertical-align: middle;}
        
        /* اصلاح رنگ متن‌ها در جدول برای خوانایی روی زمینه تیره */
        .table tbody td { 
            vertical-align: middle; 
            border-bottom: 1px solid #334155; 
            text-align: center; 
            background-color: #1e293b; 
            color: #fff !important; 
        }
        
        /* دکمه شارژ سهمیه */
        .btn-charge { background-color: #10b981; color: white; border: none; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
        .btn-charge:hover { background-color: #059669; transform: scale(1.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: #1e293b !important; border-bottom: 1px solid #334155;">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#" style="color: #38bdf8 !important; font-weight: 900;">
                <i class="bi bi-gear ms-2 fs-4"></i>
                <span>سامانه مدیریت پردازش ابری </span>
            </a>
            
            <div class="d-flex align-items-center">
                <span class="text-light ms-3 d-flex align-items-center gap-3" id="username-display"></span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm px-3 d-flex align-items-center">
                    <i class="bi bi-box-arrow-left ms-2"></i>خروج
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-8 mb-3">
                <div class="card h-100">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-file-earmark-plus-fill ms-2 fs-5"></i>
                        <span>ثبت درخواست جدید</span>
                    </div>
                    <div class="card-body">
                        <form id="jobForm">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">نوع کارت گرافیک</label>
                                    <select class="form-select" id="gpuType">
                                        <option value="T4">NVIDIA T4</option>
                                        <option value="V100">NVIDIA V100</option>
                                        <option value="A100">NVIDIA A100</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">تعداد</label>
                                    <input type="number" class="form-control" id="gpuCount" value="1" min="1" oninput="validity.valid||(value='1');">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">مدت (ثانیه)</label>
                                    <input type="number" class="form-control" id="estimatedDuration" value="10" min="5" max="60">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">دستور</label>
                                    <input type="text" class="form-control" id="command" required placeholder="مثلاً: python train.py">
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary w-100 fw-bold d-flex justify-content-center align-items-center">
                                        <i class="bi bi-send-fill ms-2"></i>ارسال درخواست
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-header text-center">
                        <i class="bi bi-pie-chart-fill ms-2"></i>وضعیت سهمیه
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div style="width: 200px; height: 200px;">
                            <canvas id="quotaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center">
                    <i class="bi bi-clipboard-data-fill ms-2 fs-5"></i>
                    وضعیت درخواست‌ها
                </span>
                <button onclick="loadJobs()" class="btn btn-sm btn-outline-info d-flex align-items-center">
                    <i class="bi bi-arrow-clockwise ms-1"></i>بروزرسانی
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table" id="jobsTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="15%">کاربر</th>
                                <th width="15%">منابع</th>
                                <th width="15%">زمان‌بندی</th>
                                <th width="20%">دستور</th>
                                <th width="15%">وضعیت</th>
                                <th width="15%">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // متغیرهای سراسری
        const API_URL = ""; // آدرس API (چون روی همین سرور است خالی می‌گذاریم)
        let currentUser = null;
        let updateInterval = null;
        let quotaChartInstance = null;

        /**
         * تایمر خروج خودکار (Security Idle Timer)
         * اگر کاربر ۱۵ دقیقه فعالیتی نکند، برای امنیت لاگ‌اوت می‌شود.
         */
        const IDLE_TIMEOUT_MS = 15 * 60 * 1000; 
        let idleTimer;

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                Swal.fire({
                    icon: 'warning',
                    title: 'خروج امنیتی',
                    text: 'به دلیل عدم فعالیت بیش از حد مجاز، از سیستم خارج شدید.',
                    background: '#1e293b', color: '#fff',
                    confirmButtonText: 'متوجه شدم'
                }).then(() => logout());
            }, IDLE_TIMEOUT_MS);
        }

        // ریست کردن تایمر با هر حرکت موس یا کلیک
        window.onload = window.onmousemove = window.onmousedown = window.onclick = window.onscroll = window.onkeypress = resetIdleTimer;

        /**
         * بررسی وضعیت لاگین (Auth Check)
         * این تابع در ابتدای لود صفحه اجرا می‌شود تا توکن کاربر را بررسی کند.
         */
        async function checkLogin() {
            const token = localStorage.getItem("access_token");
            if (!token) { window.location.href = "/"; return; } // ریدایرکت به لاگین اگر توکن نبود
            try {
                const res = await fetch(`${API_URL}/users/me`, { headers: { "Authorization": `Bearer ${token}` } });
                if (res.ok) {
                    currentUser = await res.json();
                    
                    // ساخت بج‌های (Badge) نقش کاربری و سهمیه
                    let roleBadge = currentUser.is_admin ? 
                        '<span class="badge bg-warning text-dark d-inline-flex align-items-center"><i class="bi bi-shield-lock-fill ms-1"></i>مدیر</span>' : 
                        '<span class="badge bg-secondary d-inline-flex align-items-center"><i class="bi bi-person-fill ms-1"></i>کاربر</span>';
                    
                    let quotaBadge = `<span class="badge bg-success d-inline-flex align-items-center" title="سهمیه باقی‌مانده">
                                        <i class="bi bi-lightning-charge-fill ms-1"></i>${currentUser.quota}s
                                        <button onclick="chargeQuota()" class="btn-charge ms-2" title="خرید شارژ">+</button>
                                      </span>`;

                    // نمایش اطلاعات در نوبار
                    document.getElementById("username-display").innerHTML = `
                        <i class="bi bi-person-circle fs-5"></i>
                        <span class="fw-bold">${currentUser.username}</span>
                        ${roleBadge}
                        ${quotaBadge}
                    `;
                    
                    renderChart(); // رسم نمودار
                    loadJobs();    // دریافت لیست کارها
                    
                    // تنظیم آپدیت خودکار لیست هر ۳ ثانیه
                    if (!updateInterval) updateInterval = setInterval(loadJobs, 3000);
                } else logout();
            } catch (error) { console.error(error); }
        }

        /**
         * تابع رسم نمودار دونات (Chart.js)
         * نمایش گرافیکی میزان مصرف سهمیه کاربر.
         */
        function renderChart() {
            if (!currentUser) return;
            const ctx = document.getElementById('quotaChart').getContext('2d');
            const maxQuota = currentUser.is_admin ? 1000 : 120; // سقف فرضی
            const remaining = currentUser.quota;
            const used = maxQuota - remaining;

            if (quotaChartInstance) quotaChartInstance.destroy(); // حذف نمودار قبلی برای جلوگیری از تداخل

            quotaChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['مصرف شده', 'باقی‌مانده'],
                    datasets: [{
                        data: [used, remaining],
                        backgroundColor: ['#ef4444', '#10b981'],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff', font: { family: 'system-ui' } } } }
                }
            });
        }

        // تابع شبیه‌سازی درگاه پرداخت
        async function chargeQuota() {
            Swal.fire({
                icon: 'info',
                title: 'بخش پرداخت',
                text: 'این قابلیت در فاز بعدی پروژه و پس از اتصال به درگاه بانکی فعال خواهد شد.\n(Simulation Mode Only)',
                background: '#1e293b', color: '#fff',
                confirmButtonText: 'باشه'
            });
        }

        // تابع خروج: حذف توکن و توقف تایمرها
        function logout() { 
            localStorage.removeItem("access_token"); 
            clearInterval(updateInterval); 
            clearTimeout(idleTimer); 
            window.location.href = "/"; 
        }

        /**
         * مدیریت ارسال فرم ثبت درخواست (Job Submission)
         */
        document.getElementById("jobForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const token = localStorage.getItem("access_token");
            const countVal = parseInt(document.getElementById("gpuCount").value);
            
            // اعتبارسنجی سمت کلاینت
            if (countVal < 1) { 
                Swal.fire({ icon: 'warning', title: 'خطا', text: 'تعداد گرافیک باید حداقل ۱ باشد', background: '#1e293b', color: '#fff' }); 
                return; 
            }

            try {
                // ارسال درخواست POST به API
                const res = await fetch(`${API_URL}/jobs/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({
                        gpu_type: document.getElementById("gpuType").value,
                        gpu_count: countVal,
                        command: document.getElementById("command").value,
                        estimated_duration: parseInt(document.getElementById("estimatedDuration").value)
                    })
                });
                if (res.ok) { 
                    Swal.fire({
                        icon: 'success', title: 'ثبت شد!', text: 'درخواست شما در صف پردازش قرار گرفت.',
                        background: '#1e293b', color: '#fff', timer: 2000, showConfirmButton: false
                    });
                    document.getElementById("jobForm").reset(); 
                    loadJobs(); 
                    checkLogin(); // آپدیت سهمیه
                }
                else { 
                    const err = await res.json(); 
                    Swal.fire({ icon: 'error', title: 'خطا', text: err.detail, background: '#1e293b', color: '#fff' });
                }
            } catch (e) { Swal.fire({ icon: 'error', title: 'خطا', text: 'خطای سرور', background: '#1e293b', color: '#fff' }); }
        });

        // تابع فرمت‌دهی زمان به ساعت ایران
        function formatTime(isoString) {
            if (!isoString) return "-";
            return new Date(isoString).toLocaleTimeString('fa-IR');
        }

        /**
         * دریافت لیست درخواست‌ها و ساخت جدول (Job List)
         * شامل منطق نمایش دکمه‌های ادمین و وضعیت‌ها.
         */
        async function loadJobs() {
            const token = localStorage.getItem("access_token");
            const tbody = document.querySelector("#jobsTable tbody");
            
            try {
                const res = await fetch(`${API_URL}/jobs/`, { headers: { "Authorization": `Bearer ${token}` } });
                if (res.ok) {
                    const jobs = await res.json();
                    tbody.innerHTML = ""; 

                    // مدیریت حالت لیست خالی (Empty State)
                    if (jobs.length === 0) { 
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-5" style="color: #94a3b8;">
                                    <i class="bi bi-inbox fs-1 d-block mb-3" style="opacity: 0.5;"></i>
                                    <span>لیست پردازش‌ها خالی است.</span>
                                    <br>
                                    <small style="font-size: 0.8rem; opacity: 0.7;">برای شروع، یک درخواست جدید ثبت کنید.</small>
                                </td>
                            </tr>`;
                        return; 
                    }

                    // حلقه روی درخواست‌ها و ساخت سطر جدول
                    jobs.forEach(job => {
                        // تعیین بج وضعیت (Status Badge)
                        let st = job.status;
                        if(st==="PENDING") st=`<span class="badge bg-warning text-dark">در انتظار</span>`;
                        else if(st==="APPROVED") st=`<span class="badge bg-primary">تایید شد</span>`;
                        else if(st==="RUNNING") st=`<div class="text-info small">در حال اجرا... <div class="spinner-border spinner-border-sm ms-1"></div></div>`;
                        else if(st==="COMPLETED") st=`<span class="badge bg-success">پایان</span>`;
                        else if(st==="FAILED") st=`<span class="badge bg-danger">رد شد</span>`;

                        // دکمه‌های عملیاتی (حذف)
                        let btns = `<button onclick="deleteJob(${job.id})" class="btn btn-sm btn-outline-danger" title="حذف"><i class="bi bi-trash3-fill"></i></button>`;
                        
                        // دکمه‌های مخصوص ادمین (تایید/رد)
                        if (currentUser && currentUser.is_admin && job.status === "PENDING") {
                            btns += ` <button onclick="updateStatus(${job.id}, 'APPROVED')" class="btn btn-sm btn-success ms-1"><i class="bi bi-check-lg"></i></button>
                                      <button onclick="updateStatus(${job.id}, 'FAILED')" class="btn btn-sm btn-danger ms-1"><i class="bi bi-x-lg"></i></button>`;
                        }

                        // منطق نمایش کاربر (خودم vs کاربر دیگر)
                        let userDisplay = "";
                        if (currentUser && job.owner_id === currentUser.id) {
                            userDisplay = `<span class="badge bg-info text-dark shadow-sm">خودم</span>`;
                        } else {
                            userDisplay = `<span class="text-secondary small fw-bold">کاربر ${job.owner_id}</span>`;
                        }

                        // اضافه کردن سطر به جدول
                        tbody.innerHTML += `<tr>
                            <td class="fw-bold text-white">${job.id}</td>
                            <td>${userDisplay}</td>
                            <td>
                                <span class="badge bg-dark border border-secondary d-inline-flex align-items-center gap-2" style="font-family:monospace">
                                    <i class="bi bi-gpu-card text-warning"></i> <span>${job.gpu_count} × ${job.gpu_type}</span>
                                </span>
                            </td>
                            <td><div class="small" style="color: #cbd5e1;">ثبت: ${formatTime(job.created_at)}</div><div class="small text-success">${job.completed_at ? 'پایان: '+formatTime(job.completed_at) : ''}</div></td>
                            <td><code>${job.command}</code></td>
                            <td>${st}</td>
                            <td>${btns}</td>
                        </tr>`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        // تابع تغییر وضعیت توسط ادمین
        async function updateStatus(id, st) {
            const t = localStorage.getItem("access_token");
            await fetch(`${API_URL}/jobs/${id}?status_update=${st}`, { method: "PUT", headers: {"Authorization": `Bearer ${t}`} });
            loadJobs();
        }

        // تابع حذف درخواست با تاییدیه SweetAlert
        async function deleteJob(id) {
            Swal.fire({
                title: 'آیا حذف شود؟',
                text: "این عملیات غیرقابل بازگشت است!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#334155',
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'لغو',
                background: '#1e293b', color: '#fff'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const t = localStorage.getItem("access_token");
                    await fetch(`${API_URL}/jobs/${id}`, { method: "DELETE", headers: {"Authorization": `Bearer ${t}`} });
                    checkLogin(); 
                    loadJobs();
                    Swal.fire({ title: 'حذف شد!', icon: 'success', background: '#1e293b', color: '#fff', timer: 1500, showConfirmButton: false });
                }
            });
        }
        
        // شروع برنامه
        checkLogin();
    </script>
</body>
</html>