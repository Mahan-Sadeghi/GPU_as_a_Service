<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª GPU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: Tahoma, sans-serif; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø¨Ø±ÛŒ</a>
        <div class="d-flex align-items-center">
            <span id="userInfo" class="text-light me-3 small"></span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ğŸ“‹ Ù„ÛŒØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ÛŒ</h3>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newJobModal">
            + Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Ø´Ù†Ø§Ø³Ù‡</th>
                            <th>Ú©Ø§Ø±Ø¨Ø±</th>
                            <th>Ù…Ø´Ø®ØµØ§Øª</th>
                            <th>Ø¯Ø³ØªÙˆØ±</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th> </tr>
                    </thead>
                    <tbody id="jobsTableBody">
                    </tbody>
                </table>
            </div>
            <p id="loadingText" class="text-center text-muted mt-3">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="newJobModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createJobForm">
                    <div class="mb-3">
                        <label class="form-label">Ù†ÙˆØ¹ Ú©Ø§Ø±Øª Ú¯Ø±Ø§ÙÛŒÚ©</label>
                        <select class="form-select" id="gpuType">
                            <option value="T4">NVIDIA T4</option>
                            <option value="V100">NVIDIA V100</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ØªØ¹Ø¯Ø§Ø¯</label>
                            <input type="number" class="form-control" id="gpuCount" value="1" min="1" max="4">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ù…Ø¯Øª (Ø«Ø§Ù†ÛŒÙ‡)</label>
                            <input type="number" class="form-control" id="duration" value="10" min="5">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø¯Ø³ØªÙˆØ± (Command)</label>
                        <input type="text" class="form-control" id="command" placeholder="python train.py" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Ø§Ø±Ø³Ø§Ù„</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const token = localStorage.getItem('token');
    let isAdmin = false; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ú©Ø§Ø±Ø¨Ø± Ù…Ø¹Ù…ÙˆÙ„ÛŒ
    let currentUsername = "";

    if (!token) window.location.href = "/";

    // 1. Ø§ÙˆÙ„ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± Ú©ÛŒØ³Øª (Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª ÛŒØ§ Ù†Ù‡ØŸ)
    async function checkUserRole() {
        try {
            const response = await fetch('/users/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const user = await response.json();
                isAdmin = user.is_admin; // Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø±Ø§ Ø§Ø² Ø¨Ú©â€ŒØ§Ù†Ø¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
                currentUsername = user.username;
                
                // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ùˆ Ù†Ù‚Ø´ Ø¯Ø± Ù‡Ø¯Ø±
                const roleText = isAdmin ? "(Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…)" : "(Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ)";
                document.getElementById('userInfo').innerText = `${currentUsername} ${roleText}`;
                
                loadJobs(); // Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ ÙÙ‡Ù…ÛŒØ¯ÛŒÙ… Ú©ÛŒÙ‡ØŒ Ù„ÛŒØ³Øª Ø±Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            } else {
                logout();
            }
        } catch (error) {
            console.error(error);
        }
    }

    // 2. Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù‡Ø§
    async function loadJobs() {
        const tbody = document.getElementById('jobsTableBody');
        const loadingText = document.getElementById('loadingText');
        
        try {
            const response = await fetch('/jobs/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const jobs = await response.json();
            
            tbody.innerHTML = '';
            loadingText.style.display = 'none';

            jobs.forEach(job => {
                // Ù…Ù†Ø·Ù‚ Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯: ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙˆØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª PENDING Ø¨ÙˆØ¯
                let actionButton = '-';
                if (isAdmin && job.status === 'PENDING') {
                    actionButton = `
                        <button class="btn btn-sm btn-outline-success" onclick="approveJob(${job.id})">
                            âœ… ØªØ§ÛŒÛŒØ¯
                        </button>
                    `;
                }

                const row = `
                    <tr>
                        <td>${job.id}</td>
                        <td>${job.owner_id}</td>
                        <td>${job.gpu_count}x ${job.gpu_type} (${job.estimated_duration}s)</td>
                        <td class="text-monospace small" dir="ltr">${job.command}</td>
                        <td>${getStatusBadge(job.status)}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

        } catch (error) {
            console.error(error);
        }
    }

    // 3. ØªØ§Ø¨Ø¹ ØªØ§ÛŒÛŒØ¯ ØªØ³Ú© (Ù…Ø®ØµÙˆØµ Ø§Ø¯Ù…ÛŒÙ†)
    async function approveJob(jobId) {
        if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯ØŸ")) return;

        try {
            // Ù†Ú©ØªÙ‡: Ø§ÛŒÙ†Ø¬Ø§ approved Ø¨Ø§ÛŒØ¯ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ Ø¨Ø§Ø´Ø¯
            const response = await fetch(`/jobs/${jobId}?status_update=APPROVED`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                loadJobs(); // Ø±ÙØ±Ø´ Ø¬Ø¯ÙˆÙ„
            } else {
                alert("Ø®Ø·Ø§: Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯ ÛŒØ§ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡.");
            }
        } catch (error) {
            alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡");
        }
    }

    // 4. Ø³Ø§ÛŒØ± ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
    function getStatusBadge(status) {
        if (status === 'PENDING') return '<span class="badge bg-warning text-dark">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>';
        if (status === 'APPROVED') return '<span class="badge bg-info">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>';
        if (status === 'RUNNING') return '<span class="badge bg-primary spinner-grow-sm">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§</span>';
        if (status === 'COMPLETED') return '<span class="badge bg-success">ØªÚ©Ù…ÛŒÙ„</span>';
        if (status === 'FAILED') return '<span class="badge bg-danger">Ø±Ø¯ Ø´Ø¯Ù‡</span>';
        return status;
    }

    document.getElementById('createJobForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        // Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ...
        const data = {
            gpu_type: document.getElementById('gpuType').value,
            gpu_count: parseInt(document.getElementById('gpuCount').value),
            estimated_duration: parseInt(document.getElementById('duration').value),
            command: document.getElementById('command').value,
            data_address: "/data/default",
            sensitivity: "normal"
        };
        const res = await fetch('/jobs/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
            body: JSON.stringify(data)
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('newJobModal')).hide();
            loadJobs();
        }
    });

    function logout() {
        localStorage.removeItem('token');
        window.location.href = "/";
    }

    // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
    checkUserRole();
    setInterval(loadJobs, 5000); // Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±

</script>

</body>
</html>