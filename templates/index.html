<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به سامانه GPU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; display: flex; align-items: center; justify-content: center; font-family: Tahoma, sans-serif; }
        .card { width: 400px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #764ba2; }
    </style>
</head>
<body>

<div class="card bg-white p-4">
    <h3 class="text-center mb-4 text-primary">سامانه پردازش GPU</h3>
    
    <ul class="nav nav-tabs mb-3" id="authTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button">ورود</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button">ثبت‌نام</button>
        </li>
    </ul>

    <div class="tab-content" id="authTabContent">
        <div class="tab-pane fade show active" id="login" role="tabpanel">
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">نام کاربری</label>
                    <input type="text" class="form-control" id="loginUser" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">رمز عبور</label>
                    <input type="password" class="form-control" id="loginPass" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">ورود به سیستم</button>
            </form>
        </div>

        <div class="tab-pane fade" id="register" role="tabpanel">
            <form id="registerForm">
                <div class="mb-3">
                    <label class="form-label">نام کاربری جدید</label>
                    <input type="text" class="form-control" id="regUser" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">رمز عبور</label>
                    <input type="password" class="form-control" id="regPass" required>
                </div>
                <button type="submit" class="btn btn-success w-100">ایجاد حساب کاربری</button>
            </form>
        </div>
    </div>
    
    <div id="alertBox" class="alert mt-3 d-none"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 1. لاجیک ثبت‌نام (Register) ---
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault(); // جلوگیری از ریلود شدن صفحه
        const user = document.getElementById('regUser').value;
        const pass = document.getElementById('regPass').value;
        const alertBox = document.getElementById('alertBox');

        try {
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, password: pass })
            });

            if (response.ok) {
                showAlert('ثبت‌نام موفقیت‌آمیز بود! حالا وارد شوید.', 'success');
                // سوئیچ خودکار به تب لاگین
                document.getElementById('login-tab').click();
            } else {
                const data = await response.json();
                showAlert('خطا: ' + data.detail, 'danger');
            }
        } catch (error) {
            showAlert('خطای شبکه!', 'danger');
        }
    });

    // --- 2. لاجیک ورود (Login) ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = document.getElementById('loginUser').value;
        const pass = document.getElementById('loginPass').value;

        // فرمت ارسال داده برای OAuth2 باید URLSearchParams باشد (نه JSON)
        const formData = new URLSearchParams();
        formData.append('username', user);
        formData.append('password', pass);

        try {
            const response = await fetch('/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                // ذخیره توکن در مرورگر
                localStorage.setItem('token', data.access_token);
                showAlert('ورود موفق! در حال انتقال...', 'success');
                
                // انتقال به صفحه داشبورد
                setTimeout(() => { window.location.href = "/dashboard"; }, 1000);
            } else {
                showAlert('نام کاربری یا رمز عبور اشتباه است.', 'danger');
            }
        } catch (error) {
            showAlert('خطای ارتباط با سرور', 'danger');
        }
    });

    function showAlert(msg, type) {
        const box = document.getElementById('alertBox');
        box.className = `alert alert-${type} mt-3`;
        box.innerText = msg;
        box.classList.remove('d-none');
    }
</script>

</body>
</html>